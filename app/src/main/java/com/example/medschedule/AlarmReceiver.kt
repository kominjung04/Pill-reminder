package com.example.medscheduleimport android.app.*import android.content.BroadcastReceiverimport android.content.Contextimport android.content.Intentimport android.os.Buildimport android.util.Logimport androidx.core.app.NotificationCompatimport androidx.core.app.NotificationManagerCompatimport androidx.core.app.ActivityCompatimport android.content.pm.PackageManagerimport java.util.*class AlarmReceiver : BroadcastReceiver() {    override fun onReceive(context: Context, intent: Intent?) {        val meal = intent?.getStringExtra("meal") ?: "알림"        Log.d("AlarmReceiver", "$meal 알람 수신됨!")        // 알림 표시        showNotification(context, meal)        // AlarmActivity 실행        val alarmIntent = Intent(context, AlarmActivity::class.java)        alarmIntent.addFlags(            Intent.FLAG_ACTIVITY_NEW_TASK or                    Intent.FLAG_ACTIVITY_CLEAR_TOP or                    Intent.FLAG_ACTIVITY_SINGLE_TOP or                    Intent.FLAG_ACTIVITY_NO_USER_ACTION        )        context.startActivity(alarmIntent)        // 다음날 알람 재등록        val sp = context.getSharedPreferences("meal_prefs", Context.MODE_PRIVATE)        val hour = sp.getInt("${meal}_hour", -1)        val minute = sp.getInt("${meal}_minute", -1)        val active = sp.getBoolean("${meal}_active", false)        if (hour >= 0 && minute >= 0 && active) {            val calendar = Calendar.getInstance().apply {                timeInMillis = System.currentTimeMillis()                set(Calendar.HOUR_OF_DAY, hour)                set(Calendar.MINUTE, minute)                set(Calendar.SECOND, 0)                set(Calendar.MILLISECOND, 0)                if (timeInMillis <= System.currentTimeMillis()) add(Calendar.DAY_OF_YEAR, 1)            }            val nextIntent = Intent(context, AlarmReceiver::class.java).apply {                putExtra("meal", meal)            }            val requestCode = when (meal) {                "아침" -> 1001                "점심" -> 1002                "저녁" -> 1003                else -> 9999            }            val pending = PendingIntent.getBroadcast(                context,                requestCode,                nextIntent,                PendingIntent.FLAG_UPDATE_CURRENT or PendingIntent.FLAG_IMMUTABLE            )            val am = context.getSystemService(Context.ALARM_SERVICE) as AlarmManager            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {                am.setExactAndAllowWhileIdle(AlarmManager.RTC_WAKEUP, calendar.timeInMillis, pending)            } else {                am.setExact(AlarmManager.RTC_WAKEUP, calendar.timeInMillis, pending)            }        }    }    private fun showNotification(context: Context, meal: String) {        val channelId = "meal_channel"        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {            val manager = context.getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager            val channel = NotificationChannel(                channelId,                "Meal Notifications",                NotificationManager.IMPORTANCE_HIGH            )            channel.description = "약 알림 채널"            channel.setSound(null, null)            channel.lockscreenVisibility = Notification.VISIBILITY_PUBLIC            channel.importance = NotificationManager.IMPORTANCE_HIGH            manager.createNotificationChannel(channel)        }        val fullScreenIntent = Intent(context, AlarmActivity::class.java)        fullScreenIntent.addFlags(            Intent.FLAG_ACTIVITY_NEW_TASK or                    Intent.FLAG_ACTIVITY_CLEAR_TOP or                    Intent.FLAG_ACTIVITY_SINGLE_TOP        )        val fullScreenPendingIntent = PendingIntent.getActivity(            context,            1,            fullScreenIntent,            PendingIntent.FLAG_UPDATE_CURRENT or PendingIntent.FLAG_IMMUTABLE        )        val pendingIntent = PendingIntent.getActivity(            context, 0,            Intent(context, MainActivity::class.java),            PendingIntent.FLAG_UPDATE_CURRENT or PendingIntent.FLAG_IMMUTABLE        )        val notification = NotificationCompat.Builder(context, channelId)            .setSmallIcon(android.R.drawable.ic_dialog_info)            .setContentTitle("$meal 알림")            .setContentText("$meal 약 복용 시간입니다!")            .setPriority(NotificationCompat.PRIORITY_HIGH)            .setSound(null)            .setAutoCancel(true)            .setContentIntent(pendingIntent)            .setFullScreenIntent(fullScreenPendingIntent, true)            .build()        val manager = NotificationManagerCompat.from(context)        if (Build.VERSION.SDK_INT < Build.VERSION_CODES.TIRAMISU ||            ActivityCompat.checkSelfPermission(context, android.Manifest.permission.POST_NOTIFICATIONS)            == PackageManager.PERMISSION_GRANTED        ) {            manager.notify(meal.hashCode(), notification)        }    }}